<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CampusTrade WebSocket Test</title>

    <!-- STOMP JS -->
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        body {
            font-family: monospace;
            background: #111;
            color: #0f0;
            padding: 20px;
        }
        button {
            margin-right: 10px;
            padding: 6px 12px;
        }
        pre {
            background: #000;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #0f0;
        }
    </style>
</head>
<body>

<h2>CampusTrade WebSocket Test</h2>

<button onclick="connect()">Connect</button>
<button onclick="sendMessage()">Send Message</button>

<pre id="log"></pre>

<script>
    let stompClient = null;

    const JWT =
        "Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJiZWtkZW1pcjIyQGl0dS5lZHUudHIiLCJpYXQiOjE3NjY0OTU3NzAsImV4cCI6MTc2NjQ5NjEzMH0.clhFzgzJ6krrQrT7bqsahGGJkaqFzs-FYTYSHnR8mB0";

    function log(msg) {
        const logEl = document.getElementById("log");
        logEl.textContent += msg + "\n";
        logEl.scrollTop = logEl.scrollHeight;
    }

    function connect() {
        log("Connecting...");

        // IMPORTANT: raw WebSocket (NO SockJS, NO headers here)
        const socket = new WebSocket("ws://localhost:8080/campustrade/wst");

        stompClient = Stomp.over(socket);
        stompClient.debug = msg => console.log(msg);

        // AUTH IS HERE (STOMP CONNECT)
        stompClient.connect(
            {
                Authorization: JWT
            },
            frame => {
                log("CONNECTED");
                log(frame);

                // Subscribe to conversation topic
                stompClient.subscribe(
                    "/topic/conversations/11",
                    message => {
                        log("RECEIVED:");
                        log(message.body);
                    }
                );
            },
            error => {
                log("ERROR:");
                log(JSON.stringify(error));
            }
        );
    }

    function sendMessage() {
        if (!stompClient || !stompClient.connected) {
            log("Not connected");
            return;
        }

        const payload = {
            productId: 21,
            content: "Hello from browser"
        };

        stompClient.send(
            "/app/chat.send",
            {},
            JSON.stringify(payload)
        );

        log("SENT:");
        log(JSON.stringify(payload));
    }
</script>

</body>
</html>
